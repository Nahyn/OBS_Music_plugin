<!DOCTYPE html>
<html>

<head>
	<link rel="stylesheet" href="./style.css">
	<script>
		let userPlaylist = []

		const xhttp = new XMLHttpRequest();
		xhttp.onload = function () {
			userPlaylist = JSON.parse(this.responseText)
			playNewMusic()
		}
		xhttp.open("GET", "tracklist.json", true);
		xhttp.send();

		let musicNameElement
		let musicPlayer

		let parameterContainer
		let trackInputList = []
		let volumeInput
		let textColorInput
		let randomPlaylistInput

		let savedData = localStorage.getItem("OBS_music_plugin")
		if (savedData == undefined) {
			savedData = {
				parameterVisibility: true,
				volume: 0.20,
				textColor: "#CCCCCC",
				randomPlaylist: true
			}
		} else {
			savedData = JSON.parse(savedData)
		}

		let parameterVisibility, volume, textColor, randomPlaylist
		let remainingMusicList = []

		const saveData = () => {
			const tmpData = {
				parameterVisibility: parameterVisibility,
				volume: volume,
				textColor: textColor,
				randomPlaylist: randomPlaylist
			}

			localStorage.setItem("OBS_music_plugin", JSON.stringify(tmpData))
		}

		const initParameters = () => {
			setParameterVisibility(savedData.parameterVisibility)
			setVolume(savedData.volume)
			setTextColor(savedData.textColor)
			setRandomPlaylist(savedData.randomPlaylist)
		}

		const setParameterVisibility = (_newVisibility) => {
			parameterVisibility = _newVisibility

			if (parameterVisibility == true) {
				document.body.classList.remove("parameters_hidden")
				document.getElementById("toggle_parameters").innerHTML = "Less settings"
			} else {
				document.body.classList.add("parameters_hidden")
				document.getElementById("toggle_parameters").innerHTML = "More settings"
			}

			saveData()
		}

		const setVolume = (_newVolume) => {
			volume = _newVolume
			musicPlayer.volume = volume

			document.getElementById("volume_label").innerHTML = `Volume: ${Math.ceil(volume * 100)}%`
			document.getElementById("volume").value = volume

			saveData()
		}

		const setTextColor = (_color) => {
			textColor = _color
			musicNameElement.setAttribute("style", "color: " + textColor)
			document.getElementById("color").value = textColor

			saveData()
		}

		const setRandomPlaylist = (_random) => {
			randomPlaylist = (_random == true)
			document.getElementById("random_label").innerHTML = `Random: ${randomPlaylist ? "YES" : "NO"}`
			document.getElementById("random").checked = randomPlaylist

			saveData()
		}

		const playNewMusic = () => {
			if (userPlaylist.length > 0) {
				if (remainingMusicList.length == 0) {
					remainingMusicList = ([]).concat(userPlaylist)
				}

				let newMusicIndex = 0

				if (randomPlaylist) {
					newMusicIndex = Math.floor(Math.random() * remainingMusicList.length)
				}

				const newMusicData = remainingMusicList.splice(newMusicIndex, 1)[0]

				let musicLink = newMusicData.link
				if (musicLink == undefined) {
					musicLink = "./music/" + newMusicData.title + ".mp3"
				}

				musicPlayer.setAttribute("src", musicLink)
				musicPlayer.play()
				musicNameElement.innerHTML = newMusicData.title
				onPlay()
			}
		}

		const onPlay = () => {
			const pauseButton = document.getElementById("pause_button")
			const playButton = document.getElementById("play_button")

			document.body.classList.add("music_playing")
			document.body.classList.remove("music_paused")

			musicPlayer.play()
		}

		const onPause = () => {
			const pauseButton = document.getElementById("pause_button")
			const playButton = document.getElementById("play_button")

			document.body.classList.add("music_paused")
			document.body.classList.remove("music_playing")

			musicPlayer.pause()
		}

		window.addEventListener("load", () => {
			parameterContainer = document.getElementById("parameter_container")
			musicNameElement = document.getElementById("music_name")
			musicPlayer = document.getElementById("music_player")


			musicPlayer.addEventListener("ended", () => {
				playNewMusic()
			})

			musicPlayer.addEventListener("error", () => {
				playNewMusic()
			})

			document.getElementById("toggle_parameters").addEventListener("click", () => {
				setParameterVisibility(!parameterVisibility)
			})

			initParameters()
			playNewMusic()
		})

	</script>
</head>

<body class="parameters_hidden music_playing">
	<audio id="music_player"></audio>
	<p id="music_name"></p>

	<div id="control_container">
		<button id="pause_button" onclick="onPause()">⏸</button>

		<button id="play_button" onclick="onPlay()">⏵</button>

		<button id="next_button" onclick="playNewMusic()">⏭</button>

		<button id="toggle_parameters">
			More settings
		</button>
	</div>

	<div id="parameter_container">
		<div id="debug"></div>
		<label id="volume_label" for="volume">Volume : XX%</label>
		<input id="volume" type="range" min="0.0" max="1.0" step="0.05" onInput="setVolume(event.target.value)" />

		<label id="color_label" for="color">Color</label>
		<input id="color" type="text" onInput="setTextColor(event.target.value)" value="#CCCCCC" />

		<label id="random_label" for="random">Random : NYOS</label>
		<input style="display: none" id="random" type="checkbox"
			onInput="setRandomPlaylist(event.target.checked == true)" />
	</div>
</body>

</html>